<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RStreaming - Discover Live</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --primary: #ff0050; --dark: #121212; --glass: rgba(0,0,0,0.6); }
        body { margin: 0; background: var(--dark); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* Navigasi Bawah */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; height: 60px; background: #000; display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 0.5px solid #333; }
        .nav-item { text-align: center; font-size: 10px; color: #888; cursor: pointer; }
        .nav-item.active { color: white; }
        .btn-plus { background: white; color: black; padding: 5px 15px; border-radius: 8px; font-weight: bold; font-size: 18px; }

        /* Halaman-halaman */
        .page { display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }

        /* Card Live di Beranda */
        .live-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .live-card { position: relative; height: 250px; border-radius: 12px; overflow: hidden; background: #222; }
        .live-card img { width: 100%; height: 100%; object-fit: cover; }
        .live-info { position: absolute; bottom: 0; padding: 10px; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        .badge-live { position: absolute; top: 10px; left: 10px; background: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* Layar Live (Player) */
        #live-player-page { padding: 0; height: 100vh; background: #000; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; display: none; }
        #jitsi-container { width: 100%; height: 100%; }
        
        /* Overlay Interaksi TikTok */
        .tiktok-overlay { position: absolute; bottom: 80px; left: 0; width: 100%; padding: 20px; pointer-events: none; z-index: 2100; }
        .chat-box { height: 150px; width: 70%; overflow-y: auto; pointer-events: auto; mask-image: linear-gradient(transparent, black 20%); }
        .msg { font-size: 14px; text-shadow: 1px 1px 2px #000; margin-bottom: 5px; }
        .side-bar { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; pointer-events: auto; }
        .side-btn { background: none; border: none; color: white; font-size: 30px; text-align: center; }
        .side-btn span { font-size: 12px; display: block; }

        /* Animasi Hati */
        .heart { position: absolute; bottom: 50px; right: 20px; font-size: 40px; animation: fly 1s ease-out forwards; pointer-events: none; }
        @keyframes fly { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-400px) scale(3); } }

        #login-page { text-align: center; padding-top: 100px; }
    </style>
</head>
<body>

    <div id="login-page" class="page active">
        <h1 style="color:var(--primary); font-size: 40px;">RStreaming</h1>
        <p>Tonton Live temanmu sekarang</p><br>
        <button onclick="login()" style="padding:15px 30px; border-radius:30px; border:none; font-weight:bold;">Masuk dengan Google</button>
    </div>

    <div id="home-page" class="page">
        <h3>Sedang Live</h3>
        <div class="live-grid" id="container-live">
            </div>
    </div>

    <div id="live-player-page">
        <div id="jitsi-container"></div>
        <div class="tiktok-overlay">
            <div class="chat-box" id="chat-box"></div>
            <div class="side-bar">
                <button class="side-btn" onclick="toggleFollow()">üë§<span>Follow</span></button>
                <button class="side-btn" onclick="tapLove()">‚ù§Ô∏è<span id="love-count">0</span></button>
                <button class="side-btn" onclick="closeLive()" style="background:#444; border-radius:50%; width:40px; height:40px; font-size:15px;">X</button>
            </div>
        </div>
    </div>

    <div class="nav-bottom" id="navbar" style="display:none;">
        <div class="nav-item active" onclick="showPage('home')">üè†<br>Beranda</div>
        <div class="nav-item" onclick="goLive()"><div class="btn-plus">+</div></div>
        <div class="nav-item" onclick="showPage('profile')">üë§<br>Profil</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8P9sUYJ0dB79bly9JLbZbmgpn4MSzsQw",
            authDomain: "broser-ff83e.firebaseapp.com",
            databaseURL: "https://broser-ff83e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "broser-ff83e",
            storageBucket: "broser-ff83e.firebasestorage.app",
            messagingSenderId: "544219576610",
            appId: "1:544219576610:web:ec8254ac1ed69ae1050d7b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let jitsiApi = null;
        let currentRoom = "";

        // LOGIN
        function login() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(res => {
                document.getElementById('login-page').classList.remove('active');
                document.getElementById('home-page').classList.add('active');
                document.getElementById('navbar').style.display = 'flex';
                listenLiveStreams();
            });
        }

        // LIHAT DAFTAR LIVE
        function listenLiveStreams() {
            db.ref('active_streams').on('value', snap => {
                const container = document.getElementById('container-live');
                container.innerHTML = "";
                snap.forEach(child => {
                    const data = child.val();
                    container.innerHTML += `
                        <div class="live-card" onclick="joinStream('${child.key}', '${data.name}')">
                            <div class="badge-live">LIVE</div>
                            <img src="${data.photo}">
                            <div class="live-info"><b>${data.name}</b></div>
                        </div>
                    `;
                });
            });
        }

        // MULAI LIVE SENDIRI (GO LIVE)
        function goLive() {
            const user = auth.currentUser;
            const roomID = "RStream_" + user.uid;
            db.ref('active_streams/' + roomID).set({
                name: user.displayName,
                photo: user.photoURL,
                startedAt: Date.now()
            });
            joinStream(roomID, user.displayName);
        }

        // GABUNG KE STREAM (NONTON / LIVE)
        function joinStream(roomID, hostName) {
            currentRoom = roomID;
            document.getElementById('live-player-page').style.display = 'block';
            
            jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: roomID,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { 
                    disableDeepLinking: true, 
                    prejoinPageEnabled: false,
                    toolbarButtons: ['microphone', 'camera'] 
                },
                interfaceConfigOverwrite: { MOBILE_APP_PROMO: false }
            });

            // Listen Heart (Tap-tap)
            db.ref('taps/' + roomID).on('value', snap => {
                if(snap.exists()) spawnHeart();
            });
        }

        function tapLove() {
            db.ref('taps/' + currentRoom).set(Date.now());
        }

        function spawnHeart() {
            const h = document.createElement('div');
            h.className = 'heart'; h.innerHTML = '‚ù§Ô∏è';
            h.style.right = (Math.random() * 40 + 20) + 'px';
            document.getElementById('live-player-page').appendChild(h);
            setTimeout(() => h.remove(), 1000);
        }

        function closeLive() {
            if(jitsiApi) jitsiApi.dispose();
            document.getElementById('live-player-page').style.display = 'none';
            // Jika kita host, hapus dari list saat keluar
            db.ref('active_streams/RStream_' + auth.currentUser.uid).remove();
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + '-page').classList.add('active');
        }
    </script>
</body>
</html>
