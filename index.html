<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RStreaming - Final Premium</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff0050; --bg: #f8f9fa; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; overflow: hidden; color: #1a1a1b; }
        
        .page { display: none; height: 100vh; width: 100vw; position: absolute; flex-direction: column; }
        .page.active { display: flex; }

        /* Login */
        #login-page { background: white; justify-content: center; align-items: center; text-align: center; }
        .btn-g { padding: 12px 25px; border-radius: 10px; border: 1px solid #ddd; background: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; }

        /* Home Grid */
        .header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; overflow-y: auto; flex: 1; }
        .card { height: 250px; border-radius: 15px; overflow: hidden; background: #ddd; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .live-tag { position: absolute; top: 10px; left: 10px; background: var(--primary); color: white; font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 4px; }

        /* Player TikTok Style */
        #player-page { background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; background: #000; }
        .player-overlay { position: absolute; inset: 0; z-index: 100; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; background: linear-gradient(transparent 60%, rgba(0,0,0,0.8)); }
        
        /* Viewer & Info */
        .v-info { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.4); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; pointer-events: auto; }
        .btn-back { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; pointer-events: auto; z-index: 101; }

        /* Chat */
        .chat-container { max-height: 160px; overflow-y: auto; color: white; margin-bottom: 10px; pointer-events: auto; }
        .msg { font-size: 14px; margin-bottom: 4px; text-shadow: 1px 1px 2px #000; }
        .msg b { color: #ffeb3b; margin-right: 5px; }

        .input-wrap { display: flex; gap: 8px; pointer-events: auto; }
        input { flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; padding: 10px 15px; color: white; outline: none; }

        /* Nav */
        .nav { height: 65px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 50; }
        .btn-live { background: var(--primary); color: white; padding: 8px 20px; border-radius: 10px; font-weight: bold; }

        /* Force Play Button (JAMINAN ANTI HITAM) */
        #force-play { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 999; color: white; }
    </style>
</head>
<body>

    <div id="login-page" class="page active">
        <h1 style="color:var(--primary); font-size: 40px;">RStreaming</h1>
        <button class="btn-g" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Lanjutkan dengan Google
        </button>
    </div>

    <div id="home-page" class="page">
        <div class="header"><div class="logo">RStreaming</div><div onclick="location.reload()">üîÑ</div></div>
        <div class="grid" id="room-list"></div>
        <div class="nav">
            <div onclick="showTab('home')">üè†<br><small>Home</small></div>
            <div onclick="startLive()" class="btn-live">LIVE</div>
            <div onclick="auth.signOut()">üë§<br><small>Keluar</small></div>
        </div>
    </div>

    <div id="player-page" class="page">
        <div id="force-play" onclick="triggerPlay()">
            <span style="font-size: 50px;">‚ñ∂Ô∏è</span>
            <p>Klik untuk Menonton</p>
        </div>

        <video id="v-remote" autoplay playsinline webkit-playsinline></video>
        <video id="v-local" autoplay playsinline muted style="position:absolute; top:70px; right:20px; width:90px; height:130px; border-radius:12px; border:2px solid #fff; object-fit:cover; display:none; z-index:10;"></video>
        
        <button class="btn-back" onclick="exitLive()">‚Üê Kembali</button>
        <div class="v-info">üëÅÔ∏è <span id="view-count">0</span></div>

        <div class="player-overlay">
            <div class="chat-container" id="chat-list"></div>
            <div class="input-wrap">
                <input type="text" id="chat-in" placeholder="Ketik komentar...">
                <button onclick="sendChat()" style="background:var(--primary); border:none; color:white; border-radius:50%; width:35px; height:35px;">></button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8P9sUYJ0dB79bly9JLbZbmgpn4MSzsQw",
            authDomain: "broser-ff83e.firebaseapp.com",
            databaseURL: "https://broser-ff83e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "broser-ff83e",
            storageBucket: "broser-ff83e.firebasestorage.app",
            messagingSenderId: "544219576610",
            appId: "1:544219576610:web:ec8254ac1ed69ae1050d7b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let peer = null, myStream = null, activeRoom = "";

        // AUTH CHECK
        auth.onAuthStateChanged(user => {
            if(user) { showTab('home'); initPeer(user.uid); listenRooms(); }
            else { showTab('login'); }
        });

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        function initPeer(id) {
            // JAMINAN: Multi STUN Server Google
            peer = new Peer(id, { 
                config: { 'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' }
                ]}
            });
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', s => displayRemote(s));
            });
        }

        function displayRemote(s) {
            const v = document.getElementById('v-remote');
            v.srcObject = s;
            v.play().catch(() => {
                // JAMINAN: Munculkan tombol play kalau browser memblokir video
                document.getElementById('force-play').style.display = 'flex';
            });
        }

        function triggerPlay() {
            const v = document.getElementById('v-remote');
            v.play();
            document.getElementById('force-play').style.display = 'none';
        }

        function listenRooms() {
            db.ref('rooms').on('value', snap => {
                const list = document.getElementById('room-list'); list.innerHTML = "";
                snap.forEach(s => {
                    list.innerHTML += `<div class="card" onclick="joinLive('${s.key}')">
                        <div class="live-tag">LIVE</div>
                        <img src="${s.val().photo}">
                        <div style="position:absolute; bottom:10px; left:10px; color:white; font-weight:bold; text-shadow:1px 1px 3px #000;">${s.val().name}</div>
                    </div>`;
                });
            });
        }

        async function startLive() {
            activeRoom = auth.currentUser.uid;
            showTab('player');
            document.getElementById('v-local').style.display = 'block';
            myStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('v-local').srcObject = myStream;
            db.ref('rooms/' + activeRoom).set({ name: auth.currentUser.displayName, photo: auth.currentUser.photoURL });
            setupSocial(activeRoom);
        }

        function joinLive(id) {
            activeRoom = id;
            showTab('player');
            const call = peer.call(id, null);
            call.on('stream', s => displayRemote(s));
            setupSocial(id);
        }

        function setupSocial(id) {
            // Chat Realtime
            db.ref('chats/' + id).limitToLast(15).on('value', snap => {
                const box = document.getElementById('chat-list'); box.innerHTML = "";
                snap.forEach(c => { box.innerHTML += `<div class="msg"><b>${c.val().u}</b> ${c.val().t}</div>`; });
                box.scrollTop = box.scrollHeight;
            });
            // Viewers Count
            const vRef = db.ref('v_count/' + id + '/' + auth.currentUser.uid);
            vRef.set(true); vRef.onDisconnect().remove();
            db.ref('v_count/' + id).on('value', snap => {
                document.getElementById('view-count').innerText = snap.numChildren();
            });
        }

        function sendChat() {
            const el = document.getElementById('chat-in');
            if(el.value) { db.ref('chats/' + activeRoom).push({ u: auth.currentUser.displayName.split(' ')[0], t: el.value }); el.value = ""; }
        }

        function exitLive() {
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            if(activeRoom === auth.currentUser.uid) db.ref('rooms/' + activeRoom).remove();
            location.reload();
        }

        function showTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
        }
    </script>
</body>
</html>
