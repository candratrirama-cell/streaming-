<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RStreaming - TikTok Style</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root { --tiktok-red: #ff0050; --bg: #000; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 9999; }

        /* Pages */
        .page { display: none; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .page.active { display: flex; flex-direction: column; }

        /* Home Style */
        #home-page { padding: 15px; overflow-y: auto; padding-bottom: 90px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .card { height: 260px; border-radius: 12px; overflow: hidden; position: relative; background: #1a1a1a; border: 0.5px solid #333; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        .live-tag { position: absolute; top: 8px; left: 8px; background: var(--tiktok-red); padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; }

        /* Player TikTok UI */
        #player-page { background: #000; z-index: 2000; }
        #jitsi-container { width: 100%; height: 100%; position: absolute; }
        .overlay-tiktok { position: absolute; inset: 0; pointer-events: none; z-index: 2100; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        .interactive { pointer-events: auto; }
        
        .side-bar { position: absolute; right: 12px; bottom: 120px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .btn-love { font-size: 50px; cursor: pointer; text-shadow: 0 0 10px rgba(255,0,80,0.5); }
        .exit-x { position: absolute; top: 20px; right: 20px; font-size: 24px; color: white; background: rgba(0,0,0,0.4); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Nav */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 1500; }
        .btn-plus { background: white; color: black; padding: 4px 15px; border-radius: 8px; font-weight: bold; font-size: 20px; }

        .heart-pop { position: absolute; bottom: 120px; right: 30px; font-size: 45px; pointer-events: none; animation: fly 0.8s ease-out forwards; }
        @keyframes fly { 0% { opacity:1; transform:translateY(0) scale(1); } 100% { opacity:0; transform:translateY(-350px) scale(2); } }
    </style>
</head>
<body>

    <div id="loader"><h2>RStreaming...</h2></div>

    <div id="login-page" class="page" style="justify-content: center; align-items: center;">
        <h1 style="color:var(--tiktok-red); font-size: 50px; margin:0;">RStreaming</h1>
        <button onclick="login()" style="margin-top:20px; padding:15px 40px; border-radius:50px; border:none; font-weight:bold; background:white;">Masuk Google</button>
    </div>

    <div id="home-page" class="page">
        <h2 style="margin-top:10px;">Live Sekarang</h2>
        <div class="grid" id="stream-list"></div>
    </div>

    <div id="player-page" class="page">
        <div id="jitsi-container"></div>
        <div class="overlay-tiktok">
            <div class="exit-x interactive" onclick="stopEverything()">‚úï</div>
            <div class="side-bar interactive">
                <div class="btn-love" onclick="tapLove()">‚ù§Ô∏è</div>
            </div>
        </div>
    </div>

    <div class="nav" id="main-nav" style="display:none;">
        <div onclick="switchTab('home')">üè†<br><span style="font-size:10px">Beranda</span></div>
        <div onclick="goLiveNow()"><div class="btn-plus">+</div></div>
        <div onclick="logout()" style="color:#666;">üö™<br><span style="font-size:10px">Keluar</span></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8P9sUYJ0dB79bly9JLbZbmgpn4MSzsQw",
            authDomain: "broser-ff83e.firebaseapp.com",
            databaseURL: "https://broser-ff83e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "broser-ff83e",
            storageBucket: "broser-ff83e.firebasestorage.app",
            messagingSenderId: "544219576610",
            appId: "1:544219576610:web:ec8254ac1ed69ae1050d7b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let api = null;
        let currentRoom = "";

        // CEK LOGIN OTOMATIS (BIAR GAK LOGIN LAGI)
        auth.onAuthStateChanged(user => {
            document.getElementById('loader').style.display = 'none';
            if (user) {
                switchTab('home');
                document.getElementById('main-nav').style.display = 'flex';
                loadLiveStreams();
            } else {
                switchTab('login');
                document.getElementById('main-nav').style.display = 'none';
            }
        });

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { auth.signOut(); location.reload(); }

        function loadLiveStreams() {
            db.ref('active_streams').on('value', snap => {
                const list = document.getElementById('stream-list');
                list.innerHTML = "";
                snap.forEach(s => {
                    const d = s.val();
                    list.innerHTML += `
                        <div class="card" onclick="joinLive('${s.key}', true)">
                            <div class="live-tag">LIVE</div>
                            <img src="${d.photo}">
                            <div class="card-info"><b>${d.name}</b></div>
                        </div>`;
                });
            });
        }

        // GO LIVE (HOST)
        function goLiveNow() {
            const rid = "ROOM_" + auth.currentUser.uid;
            db.ref('active_streams/' + rid).set({ name: auth.currentUser.displayName, photo: auth.currentUser.photoURL });
            joinLive(rid, false);
        }

        // JOIN (IF WATCHER = CAMERA OFF)
        function joinLive(rid, isWatcher) {
            currentRoom = rid;
            switchTab('player');
            api = new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: rid,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: {
                    startWithAudioMuted: isWatcher,
                    startWithVideoMuted: isWatcher,
                    disableDeepLinking: true,
                    prejoinPageEnabled: false
                },
                interfaceConfigOverwrite: { MOBILE_APP_PROMO: false, TOOLBAR_BUTTONS: isWatcher ? [] : ['microphone','camera','hangup'] }
            });
            db.ref('taps/' + rid).on('value', () => showHeart());
        }

        function tapLove() { db.ref('taps/' + currentRoom).set(Date.now()); }
        function showHeart() {
            const h = document.createElement('div');
            h.className = 'heart-pop'; h.innerHTML = '‚ù§Ô∏è';
            h.style.right = (Math.random() * 50 + 20) + 'px';
            document.getElementById('player-page').appendChild(h);
            setTimeout(() => h.remove(), 800);
        }

        function stopEverything() {
            if(api) api.dispose();
            if(currentRoom === "ROOM_" + auth.currentUser.uid) db.ref('active_streams/' + currentRoom).remove();
            switchTab('home');
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
        }
    </script>
</body>
</html>
