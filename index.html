<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RStreaming - Official Premium</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #ff0050;
            --bg-light: #ffffff;
            --bg-gray: #f8f9fa;
            --text-dark: #1a1a1b;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-gray); color: var(--text-dark); font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; }

        /* Pages */
        .page { display: none; height: 100vh; width: 100vw; position: absolute; flex-direction: column; }
        .page.active { display: flex; }

        /* Header */
        .header { padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

        /* Home Grid */
        #home-page { padding-bottom: 80px; overflow-y: auto; }
        .container { padding: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); border: 1px solid #eee; position: relative; }
        .card-thumb { height: 200px; width: 100%; position: relative; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .live-label { position: absolute; top: 10px; left: 10px; background: var(--primary); color: white; font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 4px; }
        .card-footer { padding: 10px; font-size: 13px; font-weight: 600; }

        /* Player TikTok View */
        #player-page { background: #000; z-index: 2000; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .player-ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; background: linear-gradient(transparent 70%, rgba(0,0,0,0.6)); }
        .interactive { pointer-events: auto; }
        .exit-btn { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.4); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; backdrop-filter: blur(5px); }
        .side-bar { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; }
        .btn-love { font-size: 50px; cursor: pointer; filter: drop-shadow(0 0 10px rgba(255,0,80,0.5)); }

        /* Nav Bawah */
        .nav { position: fixed; bottom: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { text-align: center; font-size: 11px; color: #888; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .btn-add { background: var(--primary); color: white; width: 50px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(255,0,80,0.3); }

        /* Animation */
        .pop-heart { position: absolute; bottom: 120px; right: 30px; font-size: 40px; pointer-events: none; animation: flyUp 0.8s ease-out forwards; }
        @keyframes flyUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-300px) scale(2); } }
    </style>
</head>
<body>

    <div id="login-page" class="page active" style="justify-content:center; align-items:center; background:white;">
        <div class="logo" style="font-size: 45px; margin-bottom: 30px;">RStreaming</div>
        <button onclick="login()" style="background:#fff; border:1px solid #ddd; padding:12px 30px; border-radius:10px; font-weight:600; display:flex; align-items:center; gap:10px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Lanjutkan dengan Google
        </button>
    </div>

    <div id="home-page" class="page">
        <div class="header"><div class="logo">RStreaming</div><div onclick="location.reload()">üîÑ</div></div>
        <div class="container">
            <div style="font-weight:700; margin-bottom:15px;">Live Discovery</div>
            <div class="grid" id="stream-list"></div>
        </div>
    </div>

    <div id="player-page" class="page">
        <video id="v-remote" autoplay playsinline></video>
        <video id="v-local" autoplay playsinline muted style="position:absolute; top:80px; right:20px; width:100px; height:150px; border-radius:12px; border:2px solid white; display:none; object-fit:cover; z-index:50;"></video>
        
        <button class="exit-btn interactive" onclick="stopStream()">‚Üê Kembali</button>
        <div class="player-ui">
            <div class="side-bar interactive">
                <div class="btn-love" onclick="sendLove()">‚ù§Ô∏è</div>
            </div>
        </div>
    </div>

    <div class="nav" id="main-nav" style="display:none;">
        <div class="nav-item active" onclick="showTab('home')">üè†<br>Beranda</div>
        <div onclick="startLive()"><div class="btn-add">+</div></div>
        <div class="nav-item" onclick="auth.signOut()">üö™<br>Keluar</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8P9sUYJ0dB79bly9JLbZbmgpn4MSzsQw",
            authDomain: "broser-ff83e.firebaseapp.com",
            databaseURL: "https://broser-ff83e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "broser-ff83e",
            storageBucket: "broser-ff83e.firebasestorage.app",
            messagingSenderId: "544219576610",
            appId: "1:544219576610:web:ec8254ac1ed69ae1050d7b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let peer = null, myStream = null;

        auth.onAuthStateChanged(user => {
            if(user) {
                showTab('home');
                document.getElementById('main-nav').style.display = 'flex';
                initPeer(user.uid);
                listenLive();
            } else {
                showTab('login');
                document.getElementById('main-nav').style.display = 'none';
            }
        });

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        function initPeer(id) {
            // FIX: Server STUN Google agar tidak layar hitam
            peer = new Peer(id, {
                config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }]}
            });
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', rem => {
                    const rv = document.getElementById('v-remote');
                    rv.srcObject = rem; rv.play();
                });
            });
        }

        function listenLive() {
            db.ref('active_rooms').on('value', snap => {
                const list = document.getElementById('stream-list');
                list.innerHTML = "";
                snap.forEach(s => {
                    const d = s.val();
                    list.innerHTML += `
                        <div class="card" onclick="watchLive('${s.key}')">
                            <div class="card-thumb">
                                <div class="live-label">LIVE</div>
                                <img src="${d.photo}">
                            </div>
                            <div class="card-footer">${d.name}</div>
                        </div>`;
                });
            });
        }

        async function startLive() {
            showTab('player');
            const lv = document.getElementById('v-local');
            lv.style.display = 'block';
            myStream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}, audio: true});
            lv.srcObject = myStream;
            db.ref('active_rooms/' + auth.currentUser.uid).set({ name: auth.currentUser.displayName, photo: auth.currentUser.photoURL });
        }

        function watchLive(id) {
            showTab('player');
            const call = peer.call(id, null);
            call.on('stream', rem => {
                const rv = document.getElementById('v-remote');
                rv.srcObject = rem; rv.play();
            });
            db.ref('taps/' + id).on('value', () => popHeart());
        }

        function sendLove() { db.ref('taps/' + auth.currentUser.uid).set(Date.now()); }
        function popHeart() {
            const h = document.createElement('div');
            h.className = 'pop-heart'; h.innerHTML = '‚ù§Ô∏è';
            h.style.right = (Math.random() * 50 + 20) + 'px';
            document.getElementById('player-page').appendChild(h);
            setTimeout(() => h.remove(), 800);
        }

        function stopStream() {
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            db.ref('active_rooms/' + auth.currentUser.uid).remove();
            location.reload();
        }

        function showTab(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
        }
    </script>
</body>
</html>
